# Configuration

## Configuration Sources

The pipeline uses four distinct configuration mechanisms, each serving a different purpose. There is no unified config system.

### 1. `config.mk` (Makefile include, user-created)

**Purpose**: Environment-specific path overrides for the Makefile.

**Location**: Project root (not in version control)

**Usage**: Included at line 3 of the Makefile via `include config.mk`. This is a hard include -- if the file doesn't exist, `make` will fail.

**Typical contents**: Overrides for `BASE_PATH`, `PANTHER_VERSION`, HPC-specific paths, or other Make variables that differ between users or environments.

**Concern**: No example file exists (unlike `config.yaml.example`). New users must either create an empty file or know which variables to set. The `include` should arguably be `-include` (optional include) or the file should be documented with an example.

### 2. `config/config.yaml` (Database credentials)

**Purpose**: PostgreSQL connection profiles and PubMed FTP credentials for `pthr_db_caller`.

**Location**: `config/config.yaml` (not in version control; example at `config.yaml.example`)

**Structure** (production example for PANTHER 19.0):
```yaml
DB_DEFINITION:
  comment: The database profile to use with DB caller.
  type: string
  value: panther_test          # Active profile selector

DB_DEFINITIONS:
  comment: A list of credentials that DB caller can use.
  type: list
  value:
    - id: panther_test
      host: "panthertestdb.med.usc.edu"
      dbname: "Panther_ISP_V19"
      username: "xxxxxxxx"
      pword: "xxxxxxxx"
      load_dir: "/pgres_data/data/"
      classification_version_sid: 31

# PUBMED_CREDENTIALS
PUBMED_HOST: ftp-private.ncbi.nlm.nih.gov
PUBMED_USERID: xxxxxxxx
PUBMED_PWORD: xxxxxxxx
```

**Key fields**:
- `DB_DEFINITION.value` -- selects which profile to use (must match an `id` in the list)
- `host` -- database server hostname (e.g., `panthertestdb.med.usc.edu`)
- `dbname` -- PostgreSQL database name (e.g., `Panther_ISP_V19` for PANTHER 19.0)
- `load_dir` -- **server-side** path where PostgreSQL can find files for `COPY` commands (e.g., `/pgres_data/data/`). This must be a path on the database server, not the pipeline host.
- `classification_version_sid` -- integer ID corresponding to the PANTHER version in the database (31 for v19.0). Must match the `CLS_VER_ID` set in the Makefile for the chosen `PANTHER_VERSION`.

**Consumed by**: `pthr_db_caller.db_caller.DBCaller` (initialized without arguments in `scripts/db_caller.py`, which reads this file automatically).

### 3. Makefile Variables (Version configuration)

**Purpose**: PANTHER version selection and all derived paths.

**Key variables**:

| Variable | Default | Purpose |
|----------|---------|---------|
| `BASE_PATH` | `$(date +%Y-%m-%d)_fullgo` | Working directory for this run |
| `PANTHER_VERSION` | `15.0` | Determines library paths, `CLS_VER_ID`, version dates |
| `GAF_VERSION` | `2.2` | GAF format version |
| `GO_VERSION_DATE` | from `profile.txt` | GO release date (YYYYMMDD) |

**Version-specific paths** (set by `ifeq` blocks on `PANTHER_VERSION`):

| Variable | Purpose |
|----------|---------|
| `IDENTIFIER_PATH` | Path to PANTHER `identifier.dat` on HPC filesystem |
| `GENE_PATH` | Path to PANTHER `gene.dat` |
| `NODE_PATH` | Path to PANTHER `node.dat` |
| `TREE_NODES_DIR` | Path to per-family tree files |
| `CLS_VER_ID` | Database classification version ID |
| `PANTHER_VERSION_DATE` | Library build date (YYYYMMDD) |

**Supported versions**: 13.1, 14.0, 14.1, 15.0, 16.0, 17.0, 18.0, and an `else` block mapping to 19.0 (the current production version). The `else` block maps to `CLS_VER_ID = 31`.

**How to override**:
```bash
make PANTHER_VERSION=19.0 BASE_PATH=2024-12-01_fullgo download_fullgo
```

### 4. `profile.txt` (Runtime version metadata)

**Purpose**: Records the GO release date and PANTHER version for this pipeline run. Used as input by `createGAF.pl` and reporting scripts.

**Format** (tab-delimited):
```
GO    2024-01-15    10.5281/zenodo.XXXXXXX
PANTHER    v.19.0
```

**Generated by**: `scripts/create_profile.py` (reads `release_date.txt` from GO download)

**Alternative generation**: `scripts/make_profile_from_db.py` (queries `fullgo_version` table for preupdate data)

### 5. Environment Variable Substitution (`envsubst`)

**Purpose**: Template expansion for SLURM job scripts and shell wrappers.

**Mechanism**: Makefile recipes export variables, then use `envsubst < template.slurm > $BASE_PATH/expanded.slurm` to substitute `$VARIABLE` placeholders. The expanded scripts are written to `$BASE_PATH/` for the current run.

**Affected files**: All `.slurm` and some `.sh` files in `scripts/` are templates. They contain `$BASE_PATH`, `$GAF_FILES_PATH`, `$PANTHER_VERSION`, `$GENE_PATH`, etc.

### 6. SQL Variable Substitution

**Purpose**: Parameterize SQL queries.

**Mechanism**: `pthr_db_caller.DBCaller` replaces `{variable_name}` placeholders in SQL files with values passed via `-v` flag. Values can be JSON or comma-delimited.

**Examples**:
```bash
# JSON variables
python3 scripts/db_caller.py scripts/sql/panther_go_update/load_raw_go.sql \
  -v '{"panther_version": "19.0"}'

# Comma-delimited (positional)
python3 scripts/db_caller.py scripts/sql/table_count.sql -v panther,goanno_wf
```

**SQL placeholder format**: `{variable_name}` (curly braces, no dollar sign). Example:
```sql
select count(*) from {}.{};
-- Becomes: select count(*) from panther.goanno_wf;
```

## Configuration Relationships

The `classification_version_sid` value must be consistent across three places:
1. Makefile `CLS_VER_ID` (set by `ifeq` block based on `PANTHER_VERSION`)
2. `config.yaml` `classification_version_sid` (in the active DB profile)
3. SQL `{classification_version_sid}` placeholder (substituted at runtime by `pthr_db_caller`)

A mismatch between any of these will cause silent data corruption -- queries will return data for the wrong PANTHER version.

## PAN-GO-Specific Configuration

PAN-GO updates use additional variables passed directly on the command line:
```bash
PANGO_VERSION=2.0.2 PANGO_VERSION_DATE=2024-12-05 make update_pango_new_tables
```

These are not stored in any config file.

## Google Sheets Authentication

The reporting scripts (`publish_google_sheet.py`) use OAuth2 with:
- `resources/credentials.json` -- Google API credentials (not in version control)
- `token.pickle` -- cached OAuth token (auto-generated on first run)

## Discussion Points

### No Config Validation
None of the configuration sources are validated at pipeline start. A typo in `config.yaml`, a missing `config.mk`, or a `CLS_VER_ID` mismatch will only surface as a runtime error deep into the pipeline -- potentially after hours of processing.

### `classification_version_sid` Consistency
This integer ID must match across Makefile, config.yaml, and the actual database state. It is the most dangerous configuration value because a mismatch causes silent data corruption rather than an error.

### Hardcoded HPC Paths
The `ifeq` blocks in the Makefile contain absolute paths to USC Discovery cluster filesystems (`/auto/rcf-proj3/...`, `/project/huaiyumi_14/...`). These are not portable. The `?=` conditional assignment on some paths (like `GENE_PATH ?= ...`) allows `config.mk` overrides, but not all paths use `?=`.

### Missing `config.mk` Template
Unlike `config.yaml.example`, there is no `config.mk.example`. The required variables are undocumented. Users must reverse-engineer what to put in this file from the Makefile.

### Credential Management
Database passwords and PubMed FTP passwords are stored in plain text in `config.yaml`. Google API credentials are in `resources/credentials.json`. There is no secrets management, encryption, or environment variable fallback.

### Default PANTHER_VERSION Mismatch
The Makefile defaults to `PANTHER_VERSION = 15.0`, but the current production version is 19.0 (which falls through to the `else` block). In practice, operators always override via `config.mk` or command line, so the default is misleading rather than dangerous. However, the `else` catch-all means adding version 20.0 would require updating the `else` block's paths -- a new `ifeq` for 19.0 and a fresh `else` for 20.0.
